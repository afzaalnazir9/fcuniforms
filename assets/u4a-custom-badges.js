var stage,layerTransform;function createProduct(e){let t="";return $.ajax({type:"POST",url:"https://stark-island-04924.herokuapp.com/api/products",data:e,async:!1,success:function(e){console.log(e),t=e.variants[0].id}}),t}function createBadgeCanva(){stage=new Konva.Stage({container:"custom-badge-image-container",width:320,height:486});var e=new Konva.Layer;stage.add(e);var t=new Konva.Image({x:0,y:0,width:320,height:486});e.add(t);var n=new Image;n.onload=function(){t.image(n)},n.crossOrigin="Anonymous",n.src=$("#canvas-image-placeholder").attr("src"),$(document).on("change","input.property-badge-color",(function(){const e=$(this).data("target");$(document).find(".badge-placeholder").find("img").addClass("hidden"),$(document).find(".badge-placeholder").find(`img.${e}`).removeClass("hidden"),$(document).find(".badge-quantity-pricing").find("table").addClass("hidden"),$(document).find(".badge-quantity-pricing").find(`table.${e}`).removeClass("hidden");var n=new Image;n.onload=function(){t.image(n)},n.crossOrigin="Anonymous",n.src=$(document).find(`.custom-badge-image.${e}`).attr("xlink:href");calculatePricing($(document).find("body.product-custom-badges input.quantity__input").val())})),layerTransform=new Konva.Transformer({keepRatio:!0,centeredScaling:!0,flipEnabled:!1,enabledAnchors:["top-left","top-right","bottom-left","bottom-right"],borderDash:[3,3],anchorCornerRadius:50,anchorFill:"#4affff",anchorStroke:"#4affff"}),e.add(layerTransform);let a="#000000",d="Impact, Charcoal, sans-serif";var i=new Konva.Group({x:0,y:-10});const o=$(document).find("#badges-svg").find("defs").find("path"),s=o.length;let l=1;$.each(o,(function(e,t){i.add(new Konva.TextPath({fill:"#000000",fontSize:$(this).data("size"),fontFamily:d,fontStyle:"bold",data:$(this).attr("d"),align:"center",textBaseline:"middle",name:`text-panel${s==l?"-last":l}`,draggable:!0})),l++})),e.add(i),$(document).on("change","#badge-font-family",(function(){d="Impact"==$(this).find(":selected").val()?"Impact, Charcoal, sans-serif":"Times New Roman, Times, serif";for(var e=i.find("TextPath"),t=0;t<e.length;t++){var n=e[t];n.fontFamily(d),n.draw()}})),$(document).on("change","#badge-font-color",(function(){const e=$(this).find(":selected").val();"Black"==e?a="#000000":"Blue"==e?a="#0000ff":"Red"==e?a="#ff0000":"Green"==e&&(a="#005710");for(var t=i.find("TextPath"),n=0;n<t.length;n++){var d=t[n];d.fill(a),d.draw()}})),$(document).on("change paste keyup",".badge-text-panel",(function(e){$("#badges-svg").css("display","block"),stage.find(`.${$(this).data("target")}`)[0].text($.trim($(this).val()))})),$(document).on("change","input.property-last-badge-panel",(function(e){$(document).find("input#badge-last-panel").val(""),stage.find(".text-panel-last")[0].text(""),$(document).find("input#badge-last-panel").removeClass("hidden"),$(document).find(".last-panel-consecutive-numbers-holder").addClass("hidden"),$(document).find(".last-panel-manual-numbers-holder").addClass("hidden"),$(document).find("#badge-last-panel-same-number").prop("checked",!0),"Number"==$(this).val()?($(document).find(".number-details-holder").removeClass("hidden"),$(document).find("input#badge-last-panel").attr("type","number"),$(document).find("input#badge-last-panel").attr("placeholder","Enter Number")):($(document).find(".number-details-holder").addClass("hidden"),$(document).find("input#badge-last-panel").attr("type","text"),$(document).find("input#badge-last-panel").attr("placeholder","Enter Text"))})),$(document).on("change","input.property-badge-last-panel-number-details",(function(){$(document).find("input#badge-last-panel").val(""),stage.find(".text-panel-last")[0].text(""),$(document).find("input#badge-last-panel").attr("type","number"),$(document).find("input#consecutive-number-start").val(""),$(document).find("input#consecutive-number-end").val(""),$(document).find("#manual-number-input").val(""),"Consecutive"==$(this).val()?($(document).find(".last-panel-consecutive-numbers-holder").removeClass("hidden"),$(document).find(".last-panel-manual-numbers-holder").addClass("hidden"),$(document).find("input#badge-last-panel").addClass("hidden")):"Manually Entered"==$(this).val()?($(document).find(".last-panel-consecutive-numbers-holder").addClass("hidden"),$(document).find(".last-panel-manual-numbers-holder").removeClass("hidden"),$(document).find("input#badge-last-panel").addClass("hidden")):($(document).find(".last-panel-consecutive-numbers-holder").addClass("hidden"),$(document).find(".last-panel-manual-numbers-holder").addClass("hidden"),$(document).find("input#badge-last-panel").removeClass("hidden"))})),$(document).on("change paste keyup","#manual-number-input",(function(){$(document).find("input#badge-last-panel").attr("type","text"),$(document).find("input#badge-last-panel").val($(this).val()),stage.find(".text-panel-last")[0].text($(document).find("input#badge-last-panel").val())})),$(document).on("change paste keyup","#consecutive-number-start",(function(){$(document).find("input#badge-last-panel").attr("type","text"),$(document).find("input#badge-last-panel").val($(this).val()+"-"+$("#consecutive-number-end").val()),stage.find(".text-panel-last")[0].text($(document).find("input#badge-last-panel").val())})),$(document).on("change paste keyup","#consecutive-number-end",(function(){$(document).find("input#badge-last-panel").attr("type","text"),$(document).find("input#badge-last-panel").val($("#consecutive-number-start").val()+"-"+$(this).val()),stage.find(".text-panel-last")[0].text($(document).find("input#badge-last-panel").val())}));const c=$(document).find("foreignObject"),r=parseInt(c.attr("width")),u=parseInt(c.attr("height")),m=parseInt(c.attr("x")),p=parseInt(c.attr("y"));var f=new Konva.Image({x:m,y:p,width:r,height:u});const g=parseFloat(r/2);var b=new Konva.Group({clipFunc:function(e){e.arc(parseFloat(m+g),parseFloat(p+g),g,0,2*Math.PI,!0)}});b.add(f),e.add(b),$(document).on("click",".tab-content-item-holder.select-seal .item",(function(){$(document).find("input#seal-style").val($(this).data("badge-name"));var e=new Image;e.onload=function(){f.image(e)},e.crossOrigin="Anonymous",e.src=$(this).find("img").attr("src"),$(document).find("input#custom-seal").val(""),$(document).find(".custom-seal-details").html(""),document.body.classList.remove("overflow-hidden"),document.body.dispatchEvent(new CustomEvent("modalClosed")),$("#PopupModal-select-seal").removeAttr("open");const t=$(document).find("body.product-custom-badges input.quantity__input");t.val("1"),t.attr("min","1"),$(document).find("#custom-seal-price").val(""),removeCustomSealPrice()})),$(document).on("change","input#custom-seal",(function(e){const t=$(document).find("body.product-custom-badges input.quantity__input");if(t.val("1"),t.attr("min","1"),$(document).find("#custom-seal-price").val(""),e.target.files.length)if("png"==$(this).val().split(".").pop().toLowerCase()){$(document).find(".custom-seal-details").removeClass("error"),$(document).find(".custom-seal-details").html(`<small>${e.target.files[0].name}</small>`),document.body.classList.remove("overflow-hidden"),document.body.dispatchEvent(new CustomEvent("modalClosed")),$("#PopupModal-select-seal").removeAttr("open"),$(document).find("input#seal-style").val(`Custom (${e.target.files[0].name})`);var n=new Image;n.onload=function(){f.image(n)},n.crossOrigin="Anonymous",n.src=URL.createObjectURL(e.target.files[0]),t.val("100"),t.attr("min","100"),$(document).find("#custom-seal-price").val("$500 USD");const a=$(document).find("body.product-custom-badges input.quantity__input").val();$(document).find(".badge-price .custom-seal-price").removeClass("hidden"),$(document).find(".badge-price .custom-seal-price").data("price",500),$(document).find(".badge-price .custom-seal-price").text("Custom Seal: $500 USD"),calculatePricing(a)}else console.log("invalid extension!"),$(document).find(".custom-seal-details").addClass("error"),$(document).find(".custom-seal-details").html("<small>Only PNG format allowed</small>"),$(document).find("input#seal-style").val(""),$(this).val(""),f.image(""),removeCustomSealPrice();else $(document).find(".custom-seal-details").addClass("error"),$(document).find(".custom-seal-details").html("<small>No file selected</small>"),$(document).find("input#seal-style").val(""),$(this).val(""),f.image(""),removeCustomSealPrice()})),stage.on("click tap",(function(e){const t=e.target.attrs.name;void 0!==t&&t&&/text-panel/i.test(t)?(layerTransform.nodes([stage.find(`.${t}`)[0]]),layerTransform.moveToTop()):layerTransform.nodes([])}))}function removeCustomSealPrice(){const e=$(document).find("body.product-custom-badges input.quantity__input").val();$(document).find(".badge-price .custom-seal-price").addClass("hidden"),$(document).find(".badge-price .custom-seal-price").data("price",0),$(document).find(".badge-price .custom-seal-price").text(""),$(document).find("#custom-seal-price").val(""),calculatePricing(e)}function calculatePricing(e){let t=parseFloat($(document).find(".badge-price .price-per-quantity span"));const n=parseFloat($(document).find(".badge-price .custom-seal-price").data("price"));e<=2?t=parseFloat($(document).find(".badge-quantity-pricing").find("table:visible").find('.badge-per-price[data-quantity="1-2"]').text()):e<=5?t=parseFloat($(document).find(".badge-quantity-pricing").find("table:visible").find('.badge-per-price[data-quantity="3-5"]').text()):e<=12?t=parseFloat($(document).find(".badge-quantity-pricing").find("table:visible").find('.badge-per-price[data-quantity="6-12"]').text()):e<=24?t=parseFloat($(document).find(".badge-quantity-pricing").find("table:visible").find('.badge-per-price[data-quantity="13-24"]').text()):e<=49?t=parseFloat($(document).find(".badge-quantity-pricing").find("table:visible").find('.badge-per-price[data-quantity="25-49"]').text()):e<=99?t=parseFloat($(document).find(".badge-quantity-pricing").find("table:visible").find('.badge-per-price[data-quantity="50-99"]').text()):e<=199?t=parseFloat($(document).find(".badge-quantity-pricing").find("table:visible").find('.badge-per-price[data-quantity="100-199"]').text()):e>=200&&(t=parseFloat($(document).find(".badge-quantity-pricing").find("table:visible").find('.badge-per-price[data-quantity="200 & Up"]').text())),$(document).find(".badge-price .price-per-quantity span").text(t),$(document).find("#per-item-price").val("$"+t+" USD");const a=parseFloat(e*t+n).toFixed(2);$(document).find(".badge-price .total-price").data("price",a),$(document).find(".badge-price .total-price span").text(digits(a))}function digits(e){return e.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")}jQuery((function(e){"use strict";console.log("Custom Badges..."),createBadgeCanva(),e(document).on("click",".tabs-holder .tab-title",(function(){if(e(this).hasClass("active"))return;e(document).find(".tabs-holder .tabs-titles-holder .active").removeClass("active"),e(this).addClass("active");const t="."+e(this).data("target");e(document).find(".tabs-holder .tab-content-holder .active").removeClass("active"),e(document).find(".tabs-holder").find(t).addClass("active")})),e(document).on("click",".panel-add-star",(function(t){t.preventDefault();const n=e(this).parent().find('input[type="text"]').val();e(this).parent().find('input[type="text"]').val(n+"★"),e(this).parent().find('input[type="text"]').trigger("paste")})),e(document).on("click",".backing-attachment-holder .item",(function(){e(document).find("input#backing-attachment").val(e(this).data("backing-attachment")),document.body.classList.remove("overflow-hidden"),document.body.dispatchEvent(new CustomEvent("modalClosed")),e("#PopupModal-backing-attachment").removeAttr("open")})),e(document).on("change","input.property-badge-size",(function(t){const n=e(document).find(".badge-quantity-pricing").find(".badge-per-price");"Miniature"==e(this).val()?(e(document).find(".badge-full-size-dimension").addClass("hidden"),e(document).find(".badge-mini-dimension").removeClass("hidden"),e.each(n,(function(t,n){e(this).text(e(this).data("mini-price"))})),e(document).find("th.badge-size").text("Miniature")):(e(document).find(".badge-full-size-dimension").removeClass("hidden"),e(document).find(".badge-mini-dimension").addClass("hidden"),e.each(n,(function(t,n){e(this).text(e(this).data("full-price"))})),e(document).find("th.badge-size").text("Full Size"));calculatePricing(e(document).find("body.product-custom-badges input.quantity__input").val())})),e(document).on("change paste keyup","body.product-custom-badges input.quantity__input",(function(){calculatePricing(parseFloat(e(this).val()))})),e("button.product-form__submit").on("click",(function(t){t.preventDefault(),console.log("Add to Cart Pressed"),layerTransform.nodes([]);const n=e(this),a=e("form.u4a-custom-badges-form");if(n.attr("aria-disabled",!0),n.addClass("loading"),n.find(".loading-overlay__spinner").removeClass("hidden"),e(document).find(".custom-seal-price").data("price")>0&&e(document).find("body.product-custom-badges input.quantity__input").attr("min","100"),!a.validate().form())return console.log("does not validate"),n.attr("aria-disabled",!1),n.removeClass("loading"),void n.find(".loading-overlay__spinner").addClass("hidden");console.log("validates");let d={};var i=stage.toDataURL();d.images=[{attachment:i.replace(/^data:image\/(png|jpg);base64,/,"")}];let o=e("meta[property='og:title']").attr("content");const s=e(document).find(".property-badge-color:checked").data("target");"silver"==s?o+="S":"gold"==s&&(o+="G"),"Miniature"==e(document).find(".property-badge-size:checked").val()&&(o=o.replace("PB","MB")),d.title=o,d.sku=o;const l=e(document).find(".badge-price .total-price").data("price"),c=e(document).find("body.product-custom-badges input.quantity__input").val();d.price=parseFloat(parseFloat(l)/parseFloat(c)).toFixed(2),console.log(d);const r=createProduct(d);if(console.log("Variant ID: "+r),void 0===r||!r)return n.attr("aria-disabled",!1),n.removeClass("loading"),n.find(".loading-overlay__spinner").addClass("hidden"),void(alert("Something Went Wrong. Please Try Again")||window.location.reload());const u=a.serializeArray();let m=new FormData;e.each(u,(function(e,t){"id"==t.name&&(t.value=r),m.append(t.name,t.value)})),e.each(a.find('input[type="file"]'),(function(t,n){e.each(e(n)[0].files,(function(e,t){m.append(n.name,t)}))}));let p=!1;if(e.ajax({type:"POST",url:"/cart/add.js",dataType:"json",data:m,processData:!1,contentType:!1,async:!1,success:function(e){p=!0}}),!p)return n.attr("aria-disabled",!1),n.removeClass("loading"),n.find(".loading-overlay__spinner").addClass("hidden"),void(alert("Something Went Wrong. Please Try Again")||window.location.reload());window.location.href="/cart"})),e(document).on("click","#getProductionTemplate",(function(t){t.preventDefault(),layerTransform.nodes([]),console.log("Get Production Template Pressed");const n=e("form.u4a-custom-badges-form");if(e(document).find(".custom-seal-price").data("price")>0&&e(document).find("body.product-custom-badges input.quantity__input").attr("min","100"),!n.validate().form())return void console.log("does not validate");console.log("validates");const a=e(document).find("#getProductionTemplateHolder");a.removeClass("hidden"),a.find(".client-name").text(e(document).find("#prod-temp-name").val()),a.find(".curvature").text(e(document).find("#badge-curvature").val()),a.find(".seal-name").text(e(document).find("#seal-style").val()),a.find(".font-color").text(e(document).find("#badge-font-color").val());const d=e(document).find("#badges-svg").find("defs").find("path"),i=d.length;let o=parseInt(i);e(document).find(".prod-temp-panel").remove(),e.each(d,(function(){let t="";t=o===i?e(document).find("#badge-last-panel").val().toUpperCase():e(document).find(`#badge-panel-${o}`).val().toUpperCase(),e(`<div class="prod-temp-panel"><span>Line ${o}:</span> ${t}</div>`).insertAfter("#getProductionTemplateHolder .font-color-holder"),o--})),a.find(".badge-packing").text(e(document).find("#backing-attachment").val()),a.find(".order-date").text(e(document).find("#prod-temp-date").val()),a.find(".invoice-numb").text(e(document).find("#prod-temp-invoice-number").val()),a.find(".design-sku").text(e(document).find("#prod-temp-design-sku").val()),a.find(".order-total").text(e(document).find("#prod-temp-total-orders").val()+" total"),a.find(".additional-text").html(e(document).find("#prod-temp-additional").val().replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1<br>$2"));const s=e(document).find("body.product-custom-badges input.quantity__input").val();a.find(".quant").text(s>9?s:"0"+s),a.find(".badge-image").attr("src",stage.toDataURL())}))}));
